<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Envio Rápido para Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <h3>Envio de Arquivos para Firebase</h3>

  <label>Arquivo 1:</label>
  <input type="file" id="file1"><br><br>

  <label>Arquivo 2:</label>
  <input type="file" id="file2"><br><br>

  <label>Velocidade de envio (ms entre linhas):</label>
  <input type="range" id="speedSlider" min="1" max="1000" value="10" step="1" oninput="updateSpeedLabel(this.value)">
  <span id="speedValue">10</span> ms<br><br>

  <label for="nmeaFilter">Filtro NMEA:</label>
  <select id="nmeaFilter">
    <option value="ALL">Sem filtro</option>
    <option value="ANY">Mostrar todas sentenças (aceitar todas sentenças)</option>
    <option value="$GPGGA">$GPGGA</option>
    <option value="$GPRMC">$GPRMC</option>
    <option value="$GPVTG">$GPVTG</option>
    <option value="$GPGSA">$GPGSA</option>
    <option value="$GPGSV">$GPGSV</option>
    <option value="$GPGST">$GPGST</option>
    <option value="$GPTXT">$GPTXT</option>
    <option value="$GPZDA">$GPZDA</option>
  </select><br><br>

  <button onclick="play()">▶️ Play</button>
  <button onclick="pause()">⏸️ Pause</button><br><br>

  <div id="status">Aguardando arquivos...</div>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyAxziLelCdeXbYmmkh9LcvcwkHgXld024M",
      authDomain: "log--analyzer-web.firebaseapp.com",
      databaseURL: "https://log--analyzer-web-default-rtdb.firebaseio.com",
      projectId: "log--analyzer-web",
      storageBucket: "log--analyzer-web.appspot.com",
      messagingSenderId: "908592112855",
      appId: "1:908592112855:web:ae60fc51e47a66390f3c92",
      measurementId: "G-PEWMF5LTLQ"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();

    let linhas1 = [], linhas2 = [];
    let index = 0;
    let intervalo = null;
    let isPaused = true;
    let delay = 10;

    function updateSpeedLabel(val) {
      document.getElementById("speedValue").innerText = val;
      delay = parseInt(val);
    }

    document.getElementById("file1").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        linhas1 = e.target.result.split(/\r?\n/);
        document.getElementById("status").innerText = `Arquivo 1 carregado com ${linhas1.length} linhas.`;
      };
      reader.readAsText(file);
    });

    document.getElementById("file2").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        linhas2 = e.target.result.split(/\r?\n/);
        document.getElementById("status").innerText += ` Arquivo 2 carregado com ${linhas2.length} linhas.`;
      };
      reader.readAsText(file);
    });

    function aplicaFiltro(linha, filtro) {
      if (filtro === "ALL") return true;
      if (filtro === "ANY") return linha.startsWith("$");
      return linha.startsWith(filtro);
    }

    function play() {
      if (linhas1.length === 0 || linhas2.length === 0) {
        alert("Selecione os dois arquivos primeiro.");
        return;
      }
      if (!isPaused) return;
      isPaused = false;
      index = 0;

      const totalLinhas = Math.max(linhas1.length, linhas2.length);
      const filtro = document.getElementById("nmeaFilter").value;

      intervalo = setInterval(() => {
        if (index < totalLinhas && !isPaused) {
          const linha1 = linhas1[index] ? linhas1[index].trim() : "";
          const linha2 = linhas2[index] ? linhas2[index].trim() : "";

          if (linha1 && aplicaFiltro(linha1, filtro)) {
            db.ref("gnss").update({ raw: linha1 });
          }
          if (linha2 && aplicaFiltro(linha2, filtro)) {
            db.ref("gnss").update({ raw2: linha2 });
          }

          document.getElementById("status").innerText =
            `Enviando linha ${index + 1} de ${totalLinhas} | Velocidade: ${delay} ms`;

          index++;
        } else {
          clearInterval(intervalo);
          document.getElementById("status").innerText += " | Envio concluído.";
        }
      }, delay);
    }

    function pause() {
      isPaused = true;
      clearInterval(intervalo);
      document.getElementById("status").innerText += " | Envio pausado.";
    }
  </script>
</body>
</html>
