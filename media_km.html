<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√©dia de Velocidade de Arquivo NMEA</title>
  <style>
    :root{--bg:#0b1020;--fg:#e9ecf1;--muted:#9aa3b2;--card:#131a33;--accent:#5dd0ff;--ok:#22c55e;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Arial;background:linear-gradient(180deg,#0b1020,#0e1530);color:var(--fg)}
    .wrap{max-width:980px;margin:48px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,28px);margin:0}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .uploader{padding:20px;border:2px dashed rgba(255,255,255,.15);border-radius:14px;text-align:center;transition:.2s}
    .uploader.dragover{border-color:var(--accent);background:rgba(93,208,255,.06)}
    .row{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.row{grid-template-columns:1fr 1fr}}
    input[type=file]{display:none}
    .btn{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#121936;color:var(--fg);cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;padding:16px}
    .stat{padding:14px;border-radius:12px;background:#0f1630;border:1px solid rgba(255,255,255,.08)}
    .stat h3{margin:0 0 6px 0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.02em}
    .stat p{margin:0;font-size:20px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    details{padding:12px 16px}
    summary{cursor:pointer;color:var(--accent)}
    pre{margin:0;max-height:300px;overflow:auto;background:#0b1126;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
    .foot{color:var(--muted);font-size:13px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Calcular m√©dia de velocidade (NMEA)</h1>
      <label class="btn" for="file">üìÑ Escolher arquivo NMEA</label>
      <input id="file" type="file" accept=".nmea,.txt,.log,.csv" />
    </header>

    <div id="drop" class="card uploader">
      Arraste e solte aqui seu arquivo <strong>.nmea</strong> (ou clique em "Escolher arquivo").
      <div class="foot">Suporta senten√ßas <code>RMC</code> e <code>VTG</code> de qualquer talker (<code>GP</code>, <code>GN</code>, etc.).</div>
    </div>

    <div class="row" style="margin-top:18px">
      <section class="card">
        <div class="stats" id="stats">
          <div class="stat"><h3 am-d="label-amostras">Amostras v√°lidas</h3><p id="samples">‚Äì</p></div>
          <div class="stat"><h3>Velocidade m√©dia (knots)</h3><p id="avgKnots">‚Äì</p></div>
          <div class="stat"><h3>Velocidade m√©dia (km/h)</h3><p id="avgKmh">‚Äì</p></div>
          <div class="stat"><h3>Velocidade m√©dia (m/s)</h3><p id="avgMs">‚Äì</p></div>
        </div>
        <details>
          <summary>Ver amostras de velocidade extra√≠das</summary>
          <pre id="samplesList">(aguardando arquivo‚Ä¶)</pre>
        </details>
      </section>

      <section class="card" style="padding:16px">
        <h3 style="margin-top:0">Como funciona</h3>
        <ol>
          <li>L√™ o arquivo localmente (nada √© enviado para a internet).</li>
          <li>Procura senten√ßas <code>RMC</code> (n√≥s lemos o campo <em>Speed Over Ground</em> em <strong>knots</strong>) e <code>VTG</code> (campo <strong>knots</strong>).</li>
          <li>Ignora valores vazios/NaN; calcula a m√©dia simples das amostras.</li>
        </ol>
        <p class="foot">Formata√ß√£o aceita: <code>$GPRMC</code>, <code>$GNRMC</code>, <code>$..RMC</code>, <code>$..VTG</code>. Campos podem estar vazios; checksums s√£o ignorados.</p>
      </section>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const drop = document.getElementById('drop');
    const samplesEl = document.getElementById('samples');
    const avgKnotsEl = document.getElementById('avgKnots');
    const avgKmhEl = document.getElementById('avgKmh');
    const avgMsEl = document.getElementById('avgMs');
    const samplesListEl = document.getElementById('samplesList');

    function toNumber(x){ const n = Number(x); return Number.isFinite(n) ? n : NaN; }
    const kts2kmh = k => k * 1.852;
    const kts2ms  = k => k * 0.514444;

    function parseNMEA(text){
      const speeds = [];
      const lines = text.split(/\r?\n/);
      for (let raw of lines){
        if(!raw || raw[0] !== '$') continue;
        const line = raw.trim();
        const star = line.indexOf('*');
        const core = star > -1 ? line.slice(0, star) : line;
        const parts = core.split(',');
        const talkerType = parts[0] || '';
        if(/RMC$/i.test(talkerType)){
          // $--RMC: ... , sog(knots) at index 7
          const sog = parts[7];
          const val = toNumber(sog);
          if(Number.isFinite(val)) speeds.push(val);
        } else if(/VTG$/i.test(talkerType)){
          // $--VTG: ..., sogn at index 5 (knots)
          const sogn = parts[5];
          const val = toNumber(sogn);
          if(Number.isFinite(val)) speeds.push(val);
        }
      }
      return speeds;
    }

    function summarize(speeds){
      if(!speeds.length){
        samplesEl.textContent = '0';
        avgKnotsEl.textContent = '‚Äî';
        avgKmhEl.textContent = '‚Äî';
        avgMsEl.textContent = '‚Äî';
        samplesListEl.textContent = '(nenhuma amostra v√°lida encontrada)';
        return;
      }
      const sum = speeds.reduce((a,b)=>a+b,0);
      const avgKts = sum / speeds.length;
      samplesEl.textContent = String(speeds.length);
      avgKnotsEl.textContent = avgKts.toFixed(3);
      avgKmhEl.textContent = kts2kmh(avgKts).toFixed(3);
      avgMsEl.textContent = kts2ms(avgKts).toFixed(3);
      const preview = speeds.slice(0,500).map((v,i)=>`${i+1}. ${v} kn`).join('\n');
      samplesListEl.textContent = preview + (speeds.length>500 ? `\n... (+${speeds.length-500} linhas)` : '');
    }

    async function handleFile(file){
      if(!file) return;
      const text = await file.text();
      const speeds = parseNMEA(text);
      summarize(speeds);
    }

    // File input
    fileInput.addEventListener('change', (e)=> handleFile(e.target.files[0]));

    // Drag & drop
    ;['dragenter','dragover'].forEach(evt => drop.addEventListener(evt, (e)=>{e.preventDefault(); drop.classList.add('dragover')}));
    ;['dragleave','drop'].forEach(evt => drop.addEventListener(evt, (e)=>{e.preventDefault(); drop.classList.remove('dragover')}));
    drop.addEventListener('drop', (e)=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      handleFile(file);
    });
  </script>
</body>
</html>
