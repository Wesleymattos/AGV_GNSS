<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log remote AGV novo!</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="gps-icon.png" type="image/png">


</head>
<body>

     <div class="header-agv">
  <h1>Log remote AGV</h1>
  <img src="./gps-icon.png" alt="√çcone do AGV">
</div>

  


<button onclick="window.open('Analise_dados.html', '_blank')">
    An√°lise de dados
</button>

<button onclick="window.open('quadrante_nemea.html', '_blank')">
    Quadrante
</button>

<button onclick="window.open('media_km.html', '_blank')">
    Media de velocidade km/h
</button>
<button onclick="window.open('InteragirAGV.html', '_blank')">
    Interagir com AGV
</button>

    <button onclick="window.open('envio_firebase_com_slider.html', '_blank')">
    Envio de logs 
</button>


  <div class="map-container">
    <div class="map-box">
      
<h2 style="color: red;">
  <span id="title1">Receiver 1</span>
  <input type="text" id="input1" placeholder="Nome da Antena 1" style="margin-left: 10px;">
</h2>

      <div class="container">
      <p><b>Latitude:</b> <span id="lat_rmc">‚Äî</span></p>
      <p><b>Longitude:</b> <span id="lon_rmc">‚Äî</span></p>
      <p><b>Speed (km/h):</b> <span id="speed">‚Äî</span></p>
      <p><b>Dire√ß√£o (¬∞):</b> <span id="heading">‚Äî</span></p>
      <p><b>Data:</b> <span id="date">‚Äî</span></p>
      <p><b>Sat√©lites üõ∞Ô∏è:</b> <span id="sats">‚Äî</span></p>
      <p><b>Tens√£o bateria AGV:</b> <span id="voltage">‚Äî</span></p>
      <p><b>Sensor frontal AGV</b> <span id="SensorFront">‚Äî</span></p>
      <p><b>Hdop:</b> <span id="hdop1">‚Äî</span></p>
      </div>


      <div style="margin-top: 30px; text-align: center;">
  <h2>Enviar Comando para o Receptor</h2>
  <input type="text" id="comandoInput" placeholder="Digite um comando..." style="width: 400px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" />
  <button onclick="enviarComando()" style="padding: 10px 20px; margin-left: 10px;">Enviar</button>
  <p id="statusEnvio" style="margin-top: 10px; font-weight: bold;"></p>
      </div>


      <pre id="raw">‚Äî</pre>
      <pre id="terminal">Aguardando dados...</pre>
      <div class="controls">
        <button id="startBtn">Iniciar Log</button>
        <button id="pauseBtn" disabled>Pausar Log</button>
        <button id="stopBtn" disabled>Parar Log</button>
        <button onclick="downloadKML(path1, 'antena1.kml')">Download KML 1</button>
        <button onclick="clearPath(path1, polyline1)">Limpar Linha</button>
      </div>
      <div id="map1" class="map"></div>
    </div>
    <div class="map-box">
      
<h2>
  <span id="title2" style="color: red;">Receiver 2</span>
  <input type="text" id="input2" placeholder="Nome da Antena 2" style="margin-left: 10px;">
</h2>

      <div class="container">
      <p><b>Latitude:</b> <span id="lat_rmc2">‚Äî</span></p>
      <p><b>Longitude:</b> <span id="lon_rmc2">‚Äî</span></p>
      <p><b>Speed(km/h):</b> <span id="speed2">‚Äî</span></p>
      <p><b>Dire√ß√£o(¬∞):</b> <span id="heading2">‚Äî</span></p>
      <p><b>Data:</b> <span id="date2">‚Äî</span></p>
      <p><b>Sat√©lites üõ∞Ô∏è:</b> <span id="sats2">‚Äî</span></p>
      <p><b>Tens√£o bateria AGV:</b> <span id="voltage">‚Äî</span></p>
      <p><b>Sensor frontal AGV</b> <span id="SensorFront2">‚Äî</span></p> 
      <p><b>Hdop:</b> <span id="hdop">‚Äî</span></p>
      </div>
      

    <div style="margin-top: 30px; text-align: center;">
    <h2>Enviar Comando para o Receptor</h2>
    <input type="text" id="comandoInput2" placeholder="Digite um comando..." style="width: 400px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" />
    <button onclick="enviarComando2()" style="padding: 10px 20px; margin-left: 10px;">Enviar</button>
    <p id="statusEnvio2" style="margin-top: 10px; font-weight: bold;"></p>
    </div>
      
      <pre id="raw2">‚Äî</pre>
      <pre id="terminal2">Aguardando dados...</pre>
      <div class="controls">
        <button id="startBtn2">Iniciar Log 2</button>
        <button id="pauseBtn2" disabled>Pausar Log 2</button>
        <button id="stopBtn2" disabled>Parar Log 2</button>
        <button onclick="downloadKML(path2, 'antena2.kml')">Download KML 2</button>
        <button onclick="clearPath(path2, polyline2)">Limpar Linha</button>
      </div>
      <div id="map2" class="map"></div>
    </div>
  </div>


  <div class="map-box">
  <h2 style="color: purple;">Compara√ß√£o de Precis√£o (Mapa Combinado)</h2>
  <p>Receiver 1 (vermelho) vs Receiver 2 (azul)</p>
  <div id="mapComparado" class="map"></div>

  <!-- Bot√µes para o mapa comparado -->
<div class="controls-compare" style="margin-top:10px;">
    <button onclick="clearCombinedPaths()" style="padding:8px 12px; background:#ff4d4f; border:none; color:#fff;">Limpar Linhas Combinadas</button>
</div>
</div>

<!-- <iframe src="plot_lat_lon3.html" style="width:995px; height:1000px; border:none;"></iframe> -->
<!-- <iframe src="Parsing_quadrante_nemea2.html" style="width:1000px; height:1000px; border:none;"></iframe> -->


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxziLelCdeXbYmmkh9LcvcwkHgXld024M",
      authDomain: "log--analyzer-web.firebaseapp.com",
      databaseURL: "https://log--analyzer-web-default-rtdb.firebaseio.com",
      projectId: "log--analyzer-web",
      storageBucket: "log--analyzer-web.appspot.com",
      messagingSenderId: "908592112855",
      appId: "1:908592112855:web:ae60fc51e47a66390f3c92"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();


    function enviarComando() {
  const comando = document.getElementById("comandoInput").value;
  const status = document.getElementById("statusEnvio");

  if (comando.trim() === "") {
    status.textContent = "Por favor, digite um comando.";
    status.style.color = "red";
    return;
  }

  db.ref("receiver/comando").set(comando)
    .then(() => {
      status.textContent = "Comando enviado!";
      status.style.color = "green";
      document.getElementById("comandoInput").value = "";
    })
    .catch(error => {
      status.textContent = "Erro ao enviar comando: " + error.message;
      status.style.color = "red";
    });
}

function enviarComando2() {
  const comando = document.getElementById("comandoInput2").value;
  const status = document.getElementById("statusEnvio2");

  if (comando.trim() === "") {
    status.textContent = "Por favor, digite um comando.";
    status.style.color = "red";
    return;
  }

  db.ref("receiver/comando2").set(comando)
    .then(() => {
      status.textContent = "Comando enviado!!";
      status.style.color = "green";
      document.getElementById("comandoInput2").value = "";
    })
    .catch(error => {
      status.textContent = "Erro ao enviar comando 2: " + error.message;
      status.style.color = "red";
    });
}




    function appendToTerminal(term, line) {
      const timestamp = new Date().toLocaleTimeString();
      if (term.textContent.includes("Aguardando")) term.textContent = "";
      term.textContent += `[${timestamp}] ${line}\n`;
      term.scrollTop = term.scrollHeight;
    }

    function nmeaCoordToDecimal(coord, direction) {
      if (!coord || coord.length < 4) return null;
      let degLength = (direction === 'N' || direction === 'S') ? 2 : 3;
      let degrees = parseInt(coord.substring(0, degLength));
      let minutes = parseFloat(coord.substring(degLength));
      let dec = degrees + minutes / 60;
      if (direction === 'S' || direction === 'W') dec = -dec;
      return dec.toFixed(6);
    }

    function parseGGA(sentence) {
      const parts = sentence.split(',');
      if (parts.length < 10) return null;
      const lat = nmeaCoordToDecimal(parts[2], parts[3]);
      const lon = nmeaCoordToDecimal(parts[4], parts[5]);
      const sats = parseInt(parts[7]) || 0;
      const hdop = parseFloat(parts[8]) || 0; // <-- Adicionando HDOP
      return { lat, lon, sats, hdop };
    }

    function parseVTG(sentence) {
      const parts = sentence.split(',');
      if (parts.length < 9) return null;
      return {
        heading: parts[1],
        speed: (parseFloat(parts[7]) || 0).toFixed(1),
        date: new Date().toISOString().slice(0, 10)
      };
    }

// Define um novo √≠cone
const gpsIcon = L.icon({
  iconUrl: 'gps-icon.png', // Caminho para sua imagem
  iconSize: [32, 32],      // Tamanho do √≠cone
  iconAnchor: [16, 32],    // Ponto do √≠cone que ser√° ancorado √† coordenada
  popupAnchor: [0, -32]    // Ponto de onde o popup ser√° exibido
});

    let map1 = L.map('map1').setView([-30, -51], 19);
    let map2 = L.map('map2').setView([-30, -51], 19);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 35 }).addTo(map1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 35 }).addTo(map2);

// Usa o novo √≠cone no marcador
let marker1 = L.marker([-30, -51], { icon: gpsIcon }).addTo(map1);
let marker2 = L.marker([-30, -51], { icon: gpsIcon }).addTo(map2);
    let path1 = [], path2 = [];
    let polyline1 = L.polyline([], { color: 'red' }).addTo(map1);
    let polyline2 = L.polyline([], { color: 'blue' }).addTo(map2);

    function clearPath(path, polyline) {
      path.length = 0;
      polyline.setLatLngs([]);
    }

    function downloadKML(path, filename) {
      if (!path.length) return;
      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<Placemark><LineString><coordinates>` +
        path.map(p => `${p[1]},${p[0]},0`).join(' ') +
        `</coordinates></LineString></Placemark></Document></kml>`;
      const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    const terminal = document.getElementById("terminal");
    const terminal2 = document.getElementById("terminal2");

    let isLogging = false, isPaused = false, logLines = [];
    document.getElementById("startBtn").onclick = () => {
      isLogging = true;
      isPaused = false;
      logLines = [];
      appendToTerminal(terminal, ">>> LOG INICIADO");
      document.getElementById("startBtn").disabled = true;
      document.getElementById("pauseBtn").disabled = false;
      document.getElementById("stopBtn").disabled = false;
    };
    document.getElementById("pauseBtn").onclick = () => {
      isPaused = !isPaused;
      document.getElementById("pauseBtn").textContent = isPaused ? "Retomar Log" : "Pausar Log";
      appendToTerminal(terminal, isPaused ? ">>> LOG PAUSADO" : ">>> LOG RETOMADO");
    };
    document.getElementById("stopBtn").onclick = () => {
      isLogging = false;
      isPaused = false;
      appendToTerminal(terminal, ">>> LOG PARADO");
      document.getElementById("startBtn").disabled = false;
      document.getElementById("pauseBtn").disabled = true;
      document.getElementById("stopBtn").disabled = true;
      const blob = new Blob([logLines.join('\n')], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `log_antena1_${new Date().toISOString().replace(/[:T]/g,"-").slice(0,19)}.txt`;
      a.click();
    };

    let isLogging2 = false, isPaused2 = false, logLines2 = [];
    document.getElementById("startBtn2").onclick = () => {
      isLogging2 = true;
      isPaused2 = false;
      logLines2 = [];
      appendToTerminal(terminal2, ">>> LOG 2 INICIADO");
      document.getElementById("startBtn2").disabled = true;
      document.getElementById("pauseBtn2").disabled = false;
      document.getElementById("stopBtn2").disabled = false;
    };
    document.getElementById("pauseBtn2").onclick = () => {
      isPaused2 = !isPaused2;
      document.getElementById("pauseBtn2").textContent = isPaused2 ? "Retomar Log 2" : "Pausar Log 2";
      appendToTerminal(terminal2, isPaused2 ? ">>> LOG 2 PAUSADO" : ">>> LOG 2 RETOMADO");
    };
    document.getElementById("stopBtn2").onclick = () => {
      isLogging2 = false;
      isPaused2 = false;
      appendToTerminal(terminal2, ">>> LOG 2 PARADO");
      document.getElementById("startBtn2").disabled = false;
      document.getElementById("pauseBtn2").disabled = true;
      document.getElementById("stopBtn2").disabled = true;
      const blob = new Blob([logLines2.join('\n')], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `log_antena2_${new Date().toISOString().replace(/[:T]/g,"-").slice(0,19)}.txt`;
      a.click();
    };

    db.ref("gnss/raw").on("value", snap => {
      const raw = snap.val();
      if (!raw) return;
      document.getElementById("raw").textContent = raw;
      appendToTerminal(terminal, raw);
      if (isLogging && !isPaused) logLines.push(raw);

      if (raw.startsWith("$GPGGA")) {
        const data = parseGGA(raw);
        if (data) {
          document.getElementById("lat_rmc").textContent = data.lat;
          document.getElementById("lon_rmc").textContent = data.lon;
          document.getElementById("sats").textContent = data.sats;
          document.getElementById("hdop1").textContent = data.hdop; // <-- Novo campo
          marker1.setLatLng([+data.lat, +data.lon]);
          map1.panTo([+data.lat, +data.lon]);
          map2.panTo([+data.lat, +data.lon]);

          path1.push([+data.lat, +data.lon]);
          polyline1.setLatLngs(path1);
        }
      } else if (raw.startsWith("$GPVTG")) {
        const vtg = parseVTG(raw);
        if (vtg) {
          document.getElementById("speed").textContent = vtg.speed;
          document.getElementById("heading").textContent = vtg.heading;
          document.getElementById("date").textContent = vtg.date;
        }
      }
    });

    db.ref("gnss/raw2").on("value", snap => {
      const raw = snap.val();
      if (!raw) return;
      document.getElementById("raw2").textContent = raw;
      appendToTerminal(terminal2, raw);
      if (isLogging2 && !isPaused2) logLines2.push(raw);

      if (raw.startsWith("$GPGGA")) {
        const data = parseGGA(raw);
        if (data) {
          document.getElementById("lat_rmc2").textContent = data.lat;
          document.getElementById("lon_rmc2").textContent = data.lon;
          document.getElementById("sats2").textContent = data.sats;
          document.getElementById("hdop").textContent = data.hdop; // <-- Novo campo
          marker2.setLatLng([+data.lat, +data.lon]);
          map2.panTo([+data.lat, +data.lon]);

          path2.push([+data.lat, +data.lon]);
          polyline2.setLatLngs(path2);
        }
      } else if (raw.startsWith("$GPVTG")) {
        const vtg = parseVTG(raw);
        if (vtg) {
          document.getElementById("speed2").textContent = vtg.speed;
          document.getElementById("heading2").textContent = vtg.heading;
          document.getElementById("date2").textContent = vtg.date;
        }
      }
    });

    // Atualiza o t√≠tulo enquanto digita
// Atualiza t√≠tulo e envia para o banco
document.getElementById('input1').addEventListener('input', function () {
  const value = this.value.trim();
  document.getElementById('title1').textContent = value || 'Receiver 1';
  db.ref("receiver/receiver1").set(value || 'Receiver 1');
});

document.getElementById('input2').addEventListener('input', function () {
  const value = this.value.trim();
  document.getElementById('title2').textContent = value || 'Receiver 2';
  db.ref("receiver/receiver2").set(value || 'Receiver 2');
});

db.ref("receiver/receiver1").on("value", snapshot => {
  const value = snapshot.val();
  if (value !== null) {
    document.getElementById("input1").value = value;
    document.getElementById("title1").textContent = value;
  }
});

db.ref("receiver/receiver2").on("value", snapshot => {
  const value = snapshot.val();
  if (value !== null) {
    document.getElementById("input2").value = value;
    document.getElementById("title2").textContent = value;
  }
});

// ====== Mapa combinado para compara√ß√£o ======
let mapComparado = L.map('mapComparado').setView([-30, -51], 19);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 35
}).addTo(mapComparado);

// Marcadores combinados com √≠cones diferentes
const icon1 = L.icon({
  iconUrl: 'gps-icon.png',
  iconSize: [28, 28],
  iconAnchor: [14, 28],
});

const icon2 = L.icon({
  iconUrl: 'gps-icon.png',
  iconSize: [28, 28],
  iconAnchor: [14, 28],
  className: 'icon-blue'
});

let markerComp1 = L.marker([-30, -51], { icon: icon1 }).addTo(mapComparado);
let markerComp2 = L.marker([-30, -51], { icon: icon2 }).addTo(mapComparado);

let polylineComp1 = L.polyline([], { color: 'red' }).addTo(mapComparado);
let polylineComp2 = L.polyline([], { color: 'blue' }).addTo(mapComparado);

let pathComp1 = [];
let pathComp2 = [];

// Atualiza o mapa combinado sempre que houver novas coordenadas
function atualizarMapaComparado(lat1, lon1, lat2, lon2) {
  if (lat1 && lon1) {
    pathComp1.push([+lat1, +lon1]);
    polylineComp1.setLatLngs(pathComp1);
    markerComp1.setLatLng([+lat1, +lon1]);
    mapComparado.panTo([+lat1, +lon1], { animate: true }); // mant√©m posi√ß√£o din√¢mica sem perder zoom
  }
  if (lat2 && lon2) {
    pathComp2.push([+lat2, +lon2]);
    polylineComp2.setLatLngs(pathComp2);
    markerComp2.setLatLng([+lat2, +lon2]);
  }

  atualizarDiferenca();
}

// ====== Linha de diferen√ßa entre receptores ======
let linhaDiferenca = L.polyline([], { color: 'gray', opacity: 0.4 }).addTo(mapComparado);

let labelDistancia = L.marker([-30, -51], {
  icon: L.divIcon({
    className: '', // sem classe padr√£o pra evitar fundo branco
    html: `<div style="color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 14px;">
             0.0 cm
           </div>`
  })
}).addTo(mapComparado);


function atualizarDiferenca() {
  if (pathComp1.length > 0 && pathComp2.length > 0) {
    const p1 = pathComp1[pathComp1.length - 1];
    const p2 = pathComp2[pathComp2.length - 1];

    // Atualiza a linha entre os dois receptores
    linhaDiferenca.setLatLngs([p1, p2]);

    // Calcula dist√¢ncia (metros ‚Üí cent√≠metros)
    const distancia = mapComparado.distance(p1, p2) * 100;

    // Calcula ponto m√©dio e desloca levemente (offset)
    let midLat = (p1[0] + p2[0]) / 2;
    let midLon = (p1[1] + p2[1]) / 2;

    // deslocamento em "graus" (pequeno, depende da escala do mapa)
    const deslocamentoLat = (p2[0] - p1[0]) * 0.2; // ajuste: 0.2 = 20% mais √† direita
    const deslocamentoLon = (p2[1] - p1[1]) * 0.5;

    midLat += deslocamentoLat;
    midLon += deslocamentoLon;

    // Atualiza posi√ß√£o e texto do r√≥tulo
    labelDistancia.setLatLng([midLat, midLon]);
    labelDistancia._icon.innerHTML = `
      <div style="color: black; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 14px;">
        ${distancia.toFixed(1)} cm
      </div>`;
  }
}


// Sempre que Receiver 1 ou 2 atualizarem, reflete no mapa combinado
db.ref("gnss/raw").on("value", snap => {
  const raw = snap.val();
  if (raw && raw.startsWith("$GPGGA")) {
    const data = parseGGA(raw);
    if (data) atualizarMapaComparado(data.lat, data.lon, null, null);
  }
});

db.ref("gnss/raw2").on("value", snap => {
  const raw = snap.val();
  if (raw && raw.startsWith("$GPGGA")) {
    const data = parseGGA(raw);
    if (data) atualizarMapaComparado(null, null, data.lat, data.lon);
  }
});

function clearCombinedPaths() {
  pathComp1.length = 0;
  pathComp2.length = 0;

  polylineComp1.setLatLngs([]);
  polylineComp2.setLatLngs([]);

  const initialLat = -30.0, initialLon = -51.0;
  markerComp1.setLatLng([initialLat, initialLon]);
  markerComp2.setLatLng([initialLat, initialLon]);

  mapComparado.setView([initialLat, initialLon], 19);

  console.log("Linhas combinadas limpas.");
}



  </script>

    <script src="script.js"></script> 

      <footer>
    Desenvolvido por Wesley de Mattos ‚Äî Vers√£o 1.0.3 ‚Äî <span id="ano"></span>
  </footer>
 
  <script>
    // Pega o ano atual e insere no rodap√©
    document.getElementById("ano").textContent = new Date().getFullYear();
  </script>
</body>
</html>
