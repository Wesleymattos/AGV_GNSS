<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log remote AGV novo!</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="gps-icon.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<body>

     <div class="header-agv">
  <h1>Log remote AGV</h1>
  <img src="./gps-icon.png" alt="√çcone do AGV">
</div>

  


<button title="Analise os dados coletados" onclick="window.open('Analise_dados.html', '_blank')">
    An√°lise de dados
</button>

<button title="Vizualize o quadrante da constela√ß√£o de sat√©lites" onclick="window.open('quadrante_nemea.html', '_blank')">
    Quadrante
</button>

<button title="Fa√ßa a m√©dia de velocidade utilizando os logs coletados" onclick="window.open('media_km.html', '_blank')">
    Media de velocidade km/h
</button>
<button title="Ligue e desligue os perif√©ricos do AGV" onclick="window.open('InteragirAGV.html', '_blank')">
    Interagir com AGV
</button>

    <button title="Reproduza logs j√° coletados" onclick="window.open('envio_firebase_com_slider.html', '_blank')">
    Envio de logs 
</button>

    <button title="Gere uma tabela com a m√©dia dos valores" onclick="window.open('comparador_nmea.html', '_blank')">
    M√©dia dos valores 
</button>



  <div class="map-container">
    <div class="map-box">
      
<div style="text-align: center;">
  <h2 style="color: red;">
    <span id="title1">Receiver 1</span>
    <input type="text" id="input1" placeholder="Nome da Antena 1" style="margin-left: 10px;">
  </h2>
</div>
      <div class="container">
      <p><b title="Coordenada norte-sul da posi√ß√£o GNSS.">Latitude:</b> <span id="lat_rmc">‚Äî</span></p>
      <p><b title="Coordenada leste-oeste da posi√ß√£o GNSS.">Longitude:</b> <span id="lon_rmc">‚Äî</span></p>
      <p><b title="Velocidade atual calculada pelo receptor GNSS.">Speed (km/h):</b> <span id="speed">‚Äî</span></p>
      <p><b title="Dire√ß√£o do movimento em graus, baseada no curso.">Dire√ß√£o (¬∞):</b> <span id="heading">‚Äî</span></p>
      <p><b title="Data atual recebida do sinal GNSS.">Data:</b> <span id="date">‚Äî</span></p>
      <p><b title="N√∫mero de sat√©lites usados na solu√ß√£o de posi√ß√£o.">Sat√©lites üõ∞Ô∏è:</b> <span id="sats">‚Äî</span></p>
      <p><b title="Dilui√ß√£o horizontal da precis√£o. Quanto menor, melhor.">Hdop:</b> <span id="hdop1">‚Äî</span></p>
      <p><b title="Dilui√ß√£o da precis√£o tridimensional.">Pdop:</b> <span id="pdop1">‚Äî</span></p>
      <p><b title="Hdop calculado a partir da senten√ßa GSA.">Hdop (GSA):</b> <span id="hdop_gsa1">‚Äî</span></p>
      <p><b title="Dilui√ß√£o vertical da precis√£o.">Vdop:</b> <span id="vdop1">‚Äî</span></p>
      <p><b title="Erro m√©dio total da posi√ß√£o GNSS. Quanto menor, mais precisa.">RMS (erro total):</b> <span id="gst_rms">‚Äî</span></p>
      <p><b title="Erro 1-sigma na latitude (norte-sul).">Sigma Latitude:</b> <span id="gst_sigma_lat">‚Äî</span></p>
      <p><b title="Erro 1-sigma na longitude (leste-oeste).">Sigma Longitude:</b> <span id="gst_sigma_lon">‚Äî</span></p>
      <p><b title="Maior erro direcional da elipse de precis√£o.">Erro Semi-eixo Maior:</b> <span id="gst_major">‚Äî</span></p>
      <p><b title="Menor erro direcional da elipse de precis√£o.">Erro Semi-eixo Menor:</b> <span id="gst_minor">‚Äî</span></p>
      <p><b title="Dire√ß√£o do maior erro em rela√ß√£o ao norte geogr√°fico.">Orienta√ß√£o da Elipse (¬∞):</b> <span id="gst_orientation">‚Äî</span></p>
      </div>


      <div style="margin-top: 30px; text-align: center;">
  <h2>Enviar Comando para o Receptor</h2>
  <input type="text" id="comandoInput" placeholder="Digite um comando..." style="width: 400px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" />
  <button onclick="enviarComando()" style="padding: 10px 20px; margin-left: 10px;">Enviar</button>
  <p id="statusEnvio" style="margin-top: 10px; font-weight: bold;"></p>
      </div>


      <pre id="raw">‚Äî</pre>
      <pre id="terminal">Aguardando dados...</pre>
      <div class="controls">
        <button id="startBtn">Iniciar Log</button>
        <button id="pauseBtn" disabled>Pausar Log</button>
        <button id="stopBtn" disabled>Parar Log</button>
        <button onclick="downloadKML(path1, 'antena1.kml')">Download KML 1</button>
        <button onclick="clearPath(path1, polyline1)">Limpar Linha</button>
      </div>
      <div id="map1" class="map"></div>
    </div>
    <div class="map-box">
      
<div style="text-align: center;">
  <h2>
    <span id="title2" style="color: red;">Receiver 2</span>
    <input type="text" id="input2" placeholder="Nome da Antena 2" style="margin-left: 10px;">
  </h2>
</div>

      <div class="container">
      <p><b title="Coordenada norte-sul da posi√ß√£o GNSS.">Latitude:</b> <span id="lat_rmc2">‚Äî</span></p>
      <p><b title="Coordenada leste-oeste da posi√ß√£o GNSS.">Longitude:</b> <span id="lon_rmc2">‚Äî</span></p>
      <p><b title="Velocidade atual calculada pelo receptor GNSS.">Speed(km/h):</b> <span id="speed2">‚Äî</span></p>
      <p><b title="Dire√ß√£o do movimento em graus, baseada no curso.">Dire√ß√£o (¬∞):</b> <span id="heading2">‚Äî</span></p>
      <p><b title="Data atual recebida do sinal GNSS.">Data:</b> <span id="date2">‚Äî</span></p>
      <p><b title="N√∫mero de sat√©lites usados na solu√ß√£o de posi√ß√£o.">Sat√©lites üõ∞Ô∏è:</b> <span id="sats2">‚Äî</span></p>
      <p><b title="Dilui√ß√£o horizontal da precis√£o. Quanto menor, melhor.">Hdop:</b> <span id="hdop">‚Äî</span></p>
      <p><b title="Dilui√ß√£o da precis√£o tridimensional.">Pdop:</b> <span id="pdop">‚Äî</span></p>
      <p><b title="Hdop calculado a partir da senten√ßa GSA.">Hdop (GSA):</b> <span id="hdop_gsa">‚Äî</span></p>
      <p><b title="Dilui√ß√£o vertical da precis√£o.">Vdop:</b> <span id="vdop">‚Äî</span></p>
      <p><b title="Erro m√©dio total da posi√ß√£o GNSS. Quanto menor, mais precisa.">RMS (erro total):</b> <span id="gst_rms2">‚Äî</span></p>
      <p><b title="Erro 1-sigma na latitude (norte-sul).">Sigma Latitude:</b> <span id="gst_sigma_lat2">‚Äî</span></p>
      <p><b title="Erro 1-sigma na longitude (leste-oeste).">Sigma Longitude:</b> <span id="gst_sigma_lon2">‚Äî</span></p>
      <p><b title="Maior erro direcional da elipse de precis√£o.">Erro Semi-eixo Maior:</b> <span id="gst_major2">‚Äî</span></p>
      <p><b title="Menor erro direcional da elipse de precis√£o.">Erro Semi-eixo Menor:</b> <span id="gst_minor2">‚Äî</span></p>
      <p><b title="Dire√ß√£o do maior erro em rela√ß√£o ao norte geogr√°fico.">Orienta√ß√£o da Elipse (¬∞):</b> <span id="gst_orientation2">‚Äî</span></p>
      </div>
      

    <div style="margin-top: 30px; text-align: center;">
    <h2>Enviar Comando para o Receptor</h2>
    <input type="text" id="comandoInput2" placeholder="Digite um comando..." style="width: 400px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" />
    <button onclick="enviarComando2()" style="padding: 10px 20px; margin-left: 10px;">Enviar</button>
    <p id="statusEnvio2" style="margin-top: 10px; font-weight: bold;"></p>
    </div>
      
      <pre id="raw2">‚Äî</pre>
      <pre id="terminal2">Aguardando dados...</pre>
      <div class="controls">
        <button id="startBtn2">Iniciar Log 2</button>
        <button id="pauseBtn2" disabled>Pausar Log 2</button>
        <button id="stopBtn2" disabled>Parar Log 2</button>
        <button onclick="downloadKML(path2, 'antena2.kml')">Download KML 2</button>
        <button onclick="clearPath(path2, polyline2)">Limpar Linha</button>
      </div>
      <div id="map2" class="map"></div>
    </div>
  </div>


  <div class="map-box">
  <h2 style="color: purple;">Compara√ß√£o de Precis√£o (Mapa Combinado)</h2>
  <p>Receiver 1 (vermelho) vs Receiver 2 (azul)</p>
  <div id="mapComparado" class="map"></div>

  <!-- Bot√µes para o mapa comparado -->
<div class="controls-compare" style="margin-top:10px;">
    <button onclick="clearCombinedPaths()" style="padding:8px 12px; background:#ff4d4f; border:none; color:#fff;">Limpar Linhas Combinadas</button>
</div>
</div>

<!-- <iframe src="plot_lat_lon3.html" style="width:995px; height:1000px; border:none;"></iframe> -->
<!-- <iframe src="Parsing_quadrante_nemea2.html" style="width:1000px; height:1000px; border:none;"></iframe> -->


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAxziLelCdeXbYmmkh9LcvcwkHgXld024M",
      authDomain: "log--analyzer-web.firebaseapp.com",
      databaseURL: "https://log--analyzer-web-default-rtdb.firebaseio.com",
      projectId: "log--analyzer-web",
      storageBucket: "log--analyzer-web.appspot.com",
      messagingSenderId: "908592112855",
      appId: "1:908592112855:web:ae60fc51e47a66390f3c92"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();


    function enviarComando() {
  const comando = document.getElementById("comandoInput").value;
  const status = document.getElementById("statusEnvio");

  if (comando.trim() === "") {
    status.textContent = "Por favor, digite um comando.";
    status.style.color = "red";
    return;
  }

  db.ref("receiver/comando").set(comando)
    .then(() => {
      status.textContent = "Comando enviado!";
      status.style.color = "green";
      document.getElementById("comandoInput").value = "";
    })
    .catch(error => {
      status.textContent = "Erro ao enviar comando: " + error.message;
      status.style.color = "red";
    });
}

function enviarComando2() {
  const comando = document.getElementById("comandoInput2").value;
  const status = document.getElementById("statusEnvio2");

  if (comando.trim() === "") {
    status.textContent = "Por favor, digite um comando.";
    status.style.color = "red";
    return;
  }

  db.ref("receiver/comando2").set(comando)
    .then(() => {
      status.textContent = "Comando enviado!!";
      status.style.color = "green";
      document.getElementById("comandoInput2").value = "";
    })
    .catch(error => {
      status.textContent = "Erro ao enviar comando 2: " + error.message;
      status.style.color = "red";
    });
}




    function appendToTerminal(term, line) {
      const timestamp = new Date().toLocaleTimeString();
      if (term.textContent.includes("Aguardando")) term.textContent = "";
      term.textContent += `[${timestamp}] ${line}\n`;
      term.scrollTop = term.scrollHeight;
    }

    function nmeaCoordToDecimal(coord, direction) {
      if (!coord || coord.length < 4) return null;
      let degLength = (direction === 'N' || direction === 'S') ? 2 : 3;
      let degrees = parseInt(coord.substring(0, degLength));
      let minutes = parseFloat(coord.substring(degLength));
      let dec = degrees + minutes / 60;
      if (direction === 'S' || direction === 'W') dec = -dec;
      return dec.toFixed(6);
    }

    function parseGGA(sentence) {
      const parts = sentence.split(',');
      if (parts.length < 10) return null;
      const lat = nmeaCoordToDecimal(parts[2], parts[3]);
      const lon = nmeaCoordToDecimal(parts[4], parts[5]);
      const sats = parseInt(parts[7]) || 0;
      const hdop = parseFloat(parts[8]) || 0; // <-- Adicionando HDOP
      return { lat, lon, sats, hdop };
    }

    function parseVTG(sentence) {
      const parts = sentence.split(',');
      if (parts.length < 9) return null;
      return {
        heading: parts[1],
        speed: (parseFloat(parts[7]) || 0).toFixed(1),
        date: new Date().toISOString().slice(0, 10)
      };
    }


    function parseGSA(sentence) {
  const parts = sentence.split(',');
  if (parts.length < 18) return null;

  const mode = parts[1]; // A ou M
  const fixType = parseInt(parts[2]) || 0; // 1, 2 ou 3
  const satellites = parts.slice(3, 15).filter(s => s !== '');
  const pdop = parseFloat(parts[15]) || 0;
  const hdop = parseFloat(parts[16]) || 0;
  const vdop = parseFloat(parts[17]) || 0;

  return {
    mode,
    fixType,
    satellites,
    pdop,
    hdop,
    vdop
  };
}

function parseGST(sentence) {
  const parts = sentence.split(',');
  if (parts.length < 9) return null;

  const utcTime = parts[1];
  const rms = parseFloat(parts[2]) || 0;
  const sigmaLat = parseFloat(parts[3]) || 0;
  const sigmaLon = parseFloat(parts[4]) || 0;
  const sigmaMajor = parseFloat(parts[5]) || 0;
  const sigmaMinor = parseFloat(parts[6]) || 0;
  const orientation = parseFloat(parts[7]) || 0;
  const extra = parseFloat(parts[8]) || 0; // Campo adicional (0.06 no seu exemplo)

  return {
    utcTime,
    rms,
    sigmaLat,
    sigmaLon,
    sigmaMajor,
    sigmaMinor,
    orientation,
    extra // opcional, pode ser ignorado se n√£o for necess√°rio
  };
}

// Define um novo √≠cone
const gpsIcon = L.icon({
  iconUrl: 'gps-icon.png', // Caminho para sua imagem
  iconSize: [32, 32],      // Tamanho do √≠cone
  iconAnchor: [16, 32],    // Ponto do √≠cone que ser√° ancorado √† coordenada
  popupAnchor: [0, -32]    // Ponto de onde o popup ser√° exibido
});

    let map1 = L.map('map1').setView([-30, -51], 19);
    let map2 = L.map('map2').setView([-30, -51], 19);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 35 }).addTo(map1);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 35 }).addTo(map2);

// Usa o novo √≠cone no marcador
let marker1 = L.marker([-30, -51], { icon: gpsIcon }).addTo(map1);
let marker2 = L.marker([-30, -51], { icon: gpsIcon }).addTo(map2);
    let path1 = [], path2 = [];
    let polyline1 = L.polyline([], { color: 'red' }).addTo(map1);
    let polyline2 = L.polyline([], { color: 'blue' }).addTo(map2);

    function clearPath(path, polyline) {
      path.length = 0;
      polyline.setLatLngs([]);
    }

    function downloadKML(path, filename) {
      if (!path.length) return;
      let kml = `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n<Placemark><LineString><coordinates>` +
        path.map(p => `${p[1]},${p[0]},0`).join(' ') +
        `</coordinates></LineString></Placemark></Document></kml>`;
      const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    const terminal = document.getElementById("terminal");
    const terminal2 = document.getElementById("terminal2");

    let isLogging = false, isPaused = false, logLines = [];
    document.getElementById("startBtn").onclick = () => {
      isLogging = true;
      isPaused = false;
      logLines = [];
      appendToTerminal(terminal, ">>> LOG INICIADO");
      document.getElementById("startBtn").disabled = true;
      document.getElementById("pauseBtn").disabled = false;
      document.getElementById("stopBtn").disabled = false;
    };
    document.getElementById("pauseBtn").onclick = () => {
      isPaused = !isPaused;
      document.getElementById("pauseBtn").textContent = isPaused ? "Retomar Log" : "Pausar Log";
      appendToTerminal(terminal, isPaused ? ">>> LOG PAUSADO" : ">>> LOG RETOMADO");
    };
    document.getElementById("stopBtn").onclick = () => {
      isLogging = false;
      isPaused = false;
      appendToTerminal(terminal, ">>> LOG PARADO");
      document.getElementById("startBtn").disabled = false;
      document.getElementById("pauseBtn").disabled = true;
      document.getElementById("stopBtn").disabled = true;
      const blob = new Blob([logLines.join('\n')], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `log_antena1_${new Date().toISOString().replace(/[:T]/g,"-").slice(0,19)}.txt`;
      a.click();
    };

    let isLogging2 = false, isPaused2 = false, logLines2 = [];
    document.getElementById("startBtn2").onclick = () => {
      isLogging2 = true;
      isPaused2 = false;
      logLines2 = [];
      appendToTerminal(terminal2, ">>> LOG 2 INICIADO");
      document.getElementById("startBtn2").disabled = true;
      document.getElementById("pauseBtn2").disabled = false;
      document.getElementById("stopBtn2").disabled = false;
    };
    document.getElementById("pauseBtn2").onclick = () => {
      isPaused2 = !isPaused2;
      document.getElementById("pauseBtn2").textContent = isPaused2 ? "Retomar Log 2" : "Pausar Log 2";
      appendToTerminal(terminal2, isPaused2 ? ">>> LOG 2 PAUSADO" : ">>> LOG 2 RETOMADO");
    };
    document.getElementById("stopBtn2").onclick = () => {
      isLogging2 = false;
      isPaused2 = false;
      appendToTerminal(terminal2, ">>> LOG 2 PARADO");
      document.getElementById("startBtn2").disabled = false;
      document.getElementById("pauseBtn2").disabled = true;
      document.getElementById("stopBtn2").disabled = true;
      const blob = new Blob([logLines2.join('\n')], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `log_antena2_${new Date().toISOString().replace(/[:T]/g,"-").slice(0,19)}.txt`;
      a.click();
    };

    db.ref("gnss/raw").on("value", snap => {
      const raw = snap.val();
      if (!raw) return;
      document.getElementById("raw").textContent = raw;
      appendToTerminal(terminal, raw);
      if (isLogging && !isPaused) logLines.push(raw);

      if (raw.startsWith("$GPGGA")) {
        const data = parseGGA(raw);
        if (data) {
          document.getElementById("lat_rmc").textContent = data.lat;
          document.getElementById("lon_rmc").textContent = data.lon;
          document.getElementById("sats").textContent = data.sats;
          document.getElementById("hdop1").textContent = data.hdop; // <-- Novo campo

          window.satsForChart1 = data.sats; // ‚úÖ Atualiza gr√°fico do receptor 1
          
        // Atualiza gr√°fico
         satelliteChart.data.labels.push(satelliteChart.data.labels.length);
         satelliteChart.data.datasets[0].data.push(data.sats);
         satelliteChart.update();



          marker1.setLatLng([+data.lat, +data.lon]);
          map1.panTo([+data.lat, +data.lon]);
          map2.panTo([+data.lat, +data.lon]);

          path1.push([+data.lat, +data.lon]);
          polyline1.setLatLngs(path1);
        }
      }
       else if (raw.startsWith("$GPVTG")) {
        const vtg = parseVTG(raw);
        if (vtg) {
          document.getElementById("speed").textContent = vtg.speed;
          document.getElementById("heading").textContent = vtg.heading;
          document.getElementById("date").textContent = vtg.date;
        }
      }
      
      else if (raw.startsWith("$GPGSA")) {
      const gsa = parseGSA(raw);
      if (gsa) {
        document.getElementById("pdop1").textContent = gsa.pdop;
        document.getElementById("hdop_gsa1").textContent = gsa.hdop;
        document.getElementById("vdop1").textContent = gsa.vdop;
        document.getElementById("fixType1").textContent = gsa.fixType === 3 ? "3D" : gsa.fixType === 2 ? "2D" : "Sem fix";
        }
      }

      else if (raw.startsWith("$GPGST")) {
      const gst = parseGST(raw);
      if (gst) {
      document.getElementById("gst_rms").textContent = gst.rms.toFixed(2);
      document.getElementById("gst_sigma_lat").textContent = gst.sigmaLat.toFixed(2);
      document.getElementById("gst_sigma_lon").textContent = gst.sigmaLon.toFixed(2);
      document.getElementById("gst_major").textContent = gst.sigmaMajor.toFixed(2);
      document.getElementById("gst_minor").textContent = gst.sigmaMinor.toFixed(2);
      document.getElementById("gst_orientation").textContent = gst.orientation.toFixed(1);
        }
      }


    });

    db.ref("gnss/raw2").on("value", snap => {
      const raw = snap.val();
      if (!raw) return;
      document.getElementById("raw2").textContent = raw;
      appendToTerminal(terminal2, raw);
      if (isLogging2 && !isPaused2) logLines2.push(raw);

      if (raw.startsWith("$GPGGA")) {
        const data = parseGGA(raw);
        if (data) {
          document.getElementById("lat_rmc2").textContent = data.lat;
          document.getElementById("lon_rmc2").textContent = data.lon;
          document.getElementById("sats2").textContent = data.sats;
          document.getElementById("hdop").textContent = data.hdop; // <-- Novo campo
          marker2.setLatLng([+data.lat, +data.lon]);
          map2.panTo([+data.lat, +data.lon]);

          window.satsForChart2 = data.sats; // ‚úÖ Atualiza gr√°fico do receptor 2
          

     // Atualiza gr√°fico
      satelliteChart.data.labels.push(satelliteChart.data.labels.length);
      satelliteChart.data.datasets[1].data.push(data.sats);
      satelliteChart.update();



          path2.push([+data.lat, +data.lon]);
          polyline2.setLatLngs(path2);
        }
      } else if (raw.startsWith("$GPVTG")) {
        const vtg = parseVTG(raw);
        if (vtg) {
          document.getElementById("speed2").textContent = vtg.speed;
          document.getElementById("heading2").textContent = vtg.heading;
          document.getElementById("date2").textContent = vtg.date;
        }
      }
        else if (raw.startsWith("$GPGSA")) {
        const gsa = parseGSA(raw);
        if (gsa) {
          document.getElementById("pdop").textContent = gsa.pdop;
          document.getElementById("hdop_gsa").textContent = gsa.hdop;
          document.getElementById("vdop").textContent = gsa.vdop;
          document.getElementById("fixType").textContent = gsa.fixType === 3 ? "3D" : gsa.fixType === 2 ? "2D" : "Sem fix";
        }
      }

            else if (raw.startsWith("$GPGST")) {
      const gst = parseGST(raw);
      if (gst) {
      document.getElementById("gst_rms2").textContent = gst.rms.toFixed(2);
      document.getElementById("gst_sigma_lat2").textContent = gst.sigmaLat.toFixed(2);
      document.getElementById("gst_sigma_lon2").textContent = gst.sigmaLon.toFixed(2);
      document.getElementById("gst_major2").textContent = gst.sigmaMajor.toFixed(2);
      document.getElementById("gst_minor2").textContent = gst.sigmaMinor.toFixed(2);
      document.getElementById("gst_orientation2").textContent = gst.orientation.toFixed(1);
        }
      }
    });

    // Atualiza o t√≠tulo enquanto digita
// Atualiza t√≠tulo e envia para o banco
document.getElementById('input1').addEventListener('input', function () {
  const value = this.value.trim();
  document.getElementById('title1').textContent = value || 'Receiver 1';
  db.ref("receiver/receiver1").set(value || 'Receiver 1');
});

document.getElementById('input2').addEventListener('input', function () {
  const value = this.value.trim();
  document.getElementById('title2').textContent = value || 'Receiver 2';
  db.ref("receiver/receiver2").set(value || 'Receiver 2');
});

db.ref("receiver/receiver1").on("value", snapshot => {
  const value = snapshot.val();
  if (value !== null) {
    document.getElementById("input1").value = value;
    document.getElementById("title1").textContent = value;
  }
});

db.ref("receiver/receiver2").on("value", snapshot => {
  const value = snapshot.val();
  if (value !== null) {
    document.getElementById("input2").value = value;
    document.getElementById("title2").textContent = value;
  }
});

// ====== Mapa combinado para compara√ß√£o ======
let mapComparado = L.map('mapComparado').setView([-30, -51], 19);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 35
}).addTo(mapComparado);

// Marcadores combinados com √≠cones diferentes
const icon1 = L.icon({
  iconUrl: 'gps-icon.png',
  iconSize: [28, 28],
  iconAnchor: [14, 28],
});

const icon2 = L.icon({
  iconUrl: 'gps-icon.png',
  iconSize: [28, 28],
  iconAnchor: [14, 28],
  className: 'icon-blue'
});

let markerComp1 = L.marker([-30, -51], { icon: icon1 }).addTo(mapComparado);
let markerComp2 = L.marker([-30, -51], { icon: icon2 }).addTo(mapComparado);

let polylineComp1 = L.polyline([], { color: 'red' }).addTo(mapComparado);
let polylineComp2 = L.polyline([], { color: 'blue' }).addTo(mapComparado);

let pathComp1 = [];
let pathComp2 = [];

// Atualiza o mapa combinado sempre que houver novas coordenadas
function atualizarMapaComparado(lat1, lon1, lat2, lon2) {
  if (lat1 && lon1) {
    pathComp1.push([+lat1, +lon1]);
    polylineComp1.setLatLngs(pathComp1);
    markerComp1.setLatLng([+lat1, +lon1]);
    mapComparado.panTo([+lat1, +lon1], { animate: true }); // mant√©m posi√ß√£o din√¢mica sem perder zoom
  }
  if (lat2 && lon2) {
    pathComp2.push([+lat2, +lon2]);
    polylineComp2.setLatLngs(pathComp2);
    markerComp2.setLatLng([+lat2, +lon2]);
  }

  atualizarDiferenca();
}

// ====== Linha de diferen√ßa entre receptores ======
let linhaDiferenca = L.polyline([], { color: 'gray', opacity: 0.4 }).addTo(mapComparado);

let labelDistancia = L.marker([-30, -51], {
  icon: L.divIcon({
    className: '', // sem classe padr√£o pra evitar fundo branco
    html: `<div style="color: white; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 14px;">
             0.0 cm
           </div>`
  })
}).addTo(mapComparado);


function atualizarDiferenca() {
  if (pathComp1.length > 0 && pathComp2.length > 0) {
    const p1 = pathComp1[pathComp1.length - 1];
    const p2 = pathComp2[pathComp2.length - 1];

    // Atualiza a linha entre os dois receptores
    linhaDiferenca.setLatLngs([p1, p2]);

    // Calcula dist√¢ncia (metros ‚Üí cent√≠metros)
    const distancia = mapComparado.distance(p1, p2) * 100;

    // Calcula ponto m√©dio e desloca levemente (offset)
    let midLat = (p1[0] + p2[0]) / 2;
    let midLon = (p1[1] + p2[1]) / 2;

    // deslocamento em "graus" (pequeno, depende da escala do mapa)
    const deslocamentoLat = (p2[0] - p1[0]) * 0.2; // ajuste: 0.2 = 20% mais √† direita
    const deslocamentoLon = (p2[1] - p1[1]) * 0.5;

    midLat += deslocamentoLat;
    midLon += deslocamentoLon;

    // Atualiza posi√ß√£o e texto do r√≥tulo
    labelDistancia.setLatLng([midLat, midLon]);
    labelDistancia._icon.innerHTML = `
      <div style="color: black; font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 14px;">
        ${distancia.toFixed(1)} cm
      </div>`;
  }
}


// Sempre que Receiver 1 ou 2 atualizarem, reflete no mapa combinado
db.ref("gnss/raw").on("value", snap => {
  const raw = snap.val();
  if (raw && raw.startsWith("$GPGGA")) {
    const data = parseGGA(raw);
    if (data) atualizarMapaComparado(data.lat, data.lon, null, null);
  }
});

db.ref("gnss/raw2").on("value", snap => {
  const raw = snap.val();
  if (raw && raw.startsWith("$GPGGA")) {
    const data = parseGGA(raw);
    if (data) atualizarMapaComparado(null, null, data.lat, data.lon);
  }
});

function clearCombinedPaths() {
  pathComp1.length = 0;
  pathComp2.length = 0;

  polylineComp1.setLatLngs([]);
  polylineComp2.setLatLngs([]);

  const initialLat = -30.0, initialLon = -51.0;
  markerComp1.setLatLng([initialLat, initialLon]);
  markerComp2.setLatLng([initialLat, initialLon]);

  mapComparado.setView([initialLat, initialLon], 19);

  console.log("Linhas combinadas limpas.");
}



  </script>

    <script src="script.js"></script> 


<div id="graficoSatellites" style="margin-top: 40px; padding: 20px; border: 1px solid #ccc; background-color: #f9f9f9;">
  <h3>Sat√©lites em Tempo Real</h3>
  <canvas id="satelliteChart" width="800" height="400"></canvas>
</div>


<script>
  const ctx = document.getElementById('satelliteChart').getContext('2d');
  const satelliteChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Receiver 1',
          data: [],
          borderColor: 'rgba(255, 99, 132, 1)', // vermelho
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          fill: false,
          tension: 0.1
        },
        {
          label: 'Receiver 2',
          data: [],
          borderColor: 'rgba(54, 162, 235, 1)', // azul
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          fill: false,
          tension: 0.1
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Sat√©lites em Tempo Real'
        },
        legend: {
          display: true
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: 'Tempo (s)'
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Sat√©lites'
          },
          suggestedMax: 35
        }
      }
    }
  });
/*
 let time = 0;
setInterval(() => {
  const satellites1 = window.satsForChart1;
  const satellites2 = window.satsForChart2;

  satelliteChart.data.labels.push(time);

  satelliteChart.data.datasets[0].data.push(
    typeof satellites1 !== 'undefined' && !isNaN(satellites1) ? satellites1 : null
  );

  satelliteChart.data.datasets[1].data.push(
    typeof satellites2 !== 'undefined' && !isNaN(satellites2) ? satellites2 : null
  );

  satelliteChart.update();
  time++;
}, 1000);
*/
</script>


      <footer>
    Desenvolvido por Wesley de Mattos ‚Äî vers√£o: 1.1.11 ‚Äî <span id="ano"></span>
  </footer>
 
  <script>
    // Pega o ano atual e insere no rodap√©
    document.getElementById("ano").textContent = new Date().getFullYear();
  </script>
</body>
</html>
